<h1> Librairie de Filtrage </h1>

# Fichiers
# Dossiers
| Fichier | Objectif |
| :-------|:---------|
|generate_fir_filter.py| Script Python permettant de générer la Look Up Yable utilisé par le filtre |
|pdm_fir/| Dossier contenant les sources du filtre |
| pdm_fir/pdm_fir.h | fichier d'entête du filtre|
|pdm_fir/pdm_fir.c | fichier de source du filtre|
|*pdm_fir/pdm_fir_.h* | Fichier généré par `generate_fir_filter`, il contien la Look Up Table utilisé par le filtre ainsi certaines constantes du filtre


# Générer un filtre


Le script `generate_fir_filter` nous permet de généré la Look Up table utilisé par la bibliothèque de filtrage. Pour ce faire le script a besoin de plusieurs valeurs:



|Paramètre|Valeur Recommander | Effet|
|:-|:-|:-|
| taps | 16 | Cette valeur correspond à l'ordre du filtre du filtre numérique|
| Sampling Frequency | Pour un facteur de decimation de 64: <br />$`fs_{PDM} = 64 * fs_{PCM}`$  | Cette valeur correspond à la fréquence d'échantillonnage du Signal PDM

Avant de générér la Look Up Table d'un filtre PDM on va répondre 2 plusieurs Question:
 1. A quelle fréquence est échantillonné notre signal PDM ?
 2. Qu'elle fréquence échantillonnage visé pour le signal PCM ?






## Exemple de pdm_fir/pdm_fir_.h
```c
#ifndef PDM_FIR__H
#define PDM_FIR__H
/**
 * @file pdm_fir_.h
 * @brief File containing Generated LUT of the Fir filter
 * @date Generation: 02-11-2021 08:41:40
 */
/*
 +--------------------------------------------------+
 |                                                  |
 |         Generated by generate_pdm_fir.py         |
 |               02-11-2021 08:41:40                |
 |                                                  |
 +--------------------------------------------------+
*/

#define PDM_FTL_SCALE_BITS  30
#define PDM_FTL_TAPS        16

static const int byte_coeff[PDM_FTL_TAPS*2][256] = {
	{ // [0]
		 0x0146fa4c,  0x00eee730,  0x00f07ce4,  0x009869c8,  0x00f230b8,  0x009a1d9c,  0x009bb350,  0x0043a034,
		 0x00f40180,  0x009bee64,  0x009d8418,  0x004570fc,  0x009f37ec,  0x004724d0,  0x0048ba84, -0x000f5898,
		 0x00f5ee12,  0x009ddaf6,  0x009f70aa,  0x00475d8e,  0x00a1247e,  0x00491162,  0x004aa716, -0x000d6c06,
		 0x00a2f546,  0x004ae22a,  0x004c77de, -0x000b9b3e,  0x004e2bb2, -0x0009e76a, -0x000851b6, -0x006064d2,
		 0x00f7f53c,  0x009fe220,  0x00a177d4,  0x004964b8,  0x00a32ba8,  0x004b188c,  0x004cae40, -0x000b64dc,
		 0x00a4fc70,  0x004ce954,  0x004e7f08, -0x00099414,  0x005032dc, -0x0007e040, -0x00064a8c, -0x005e5da8,
		 0x00a6e902,  0x004ed5e6,  0x00506b9a, -0x0007a782,  0x00521f6e, -0x0005f3ae, -0x00045dfa, -0x005c7116,
		 0x0053f036, -0x000422e6, -0x00028d32, -0x005aa04e, -0x0000d95e, -0x0058ec7a, -0x005756c6, -0x00af69e2,
		 0x00fa15c2,  0x00a202a6,  0x00a3985a,  0x004b853e,  0x00a54c2e,  0x004d3912,  0x004ecec6, -0x00094456,
		 0x00a71cf6,  0x004f09da,  0x00509f8e, -0x0007738e,  0x00525362, -0x0005bfba, -0x00042a06, -0x005c3d22,
		 0x00a90988,  0x0050f66c,  0x00528c20, -0x000586fc,  0x00543ff4, -0x0003d328, -0x00023d74, -0x005a5090,
		 0x005610bc, -0x00020260, -0x00006cac, -0x00587fc8,  0x00014728, -0x0056cbf4, -0x00553640, -0x00ad495c,
		 0x00ab10b2,  0x0052fd96,  0x0054934a, -0x00037fd2,  0x0056471e, -0x0001cbfe, -0x0000364a, -0x00584966,
		 0x005817e6,  0x000004ca,  0x00019a7e, -0x0056789e,  0x00034e52, -0x0054c4ca, -0x00532f16, -0x00ab4232,
		 0x005a0478,  0x0001f15c,  0x00038710, -0x00548c0c,  0x00053ae4, -0x0052d838, -0x00514284, -0x00a955a0,
		 0x00070bac, -0x00510770, -0x004f71bc, -0x00a784d8, -0x004dbde8, -0x00a5d104, -0x00a43b50, -0x00fc4e6c,
		 0x00fc4e6c,  0x00a43b50,  0x00a5d104,  0x004dbde8,  0x00a784d8,  0x004f71bc,  0x00510770, -0x00070bac,
		 0x00a955a0,  0x00514284,  0x0052d838, -0x00053ae4,  0x00548c0c, -0x00038710, -0x0001f15c, -0x005a0478,
		 0x00ab4232,  0x00532f16,  0x0054c4ca, -0x00034e52,  0x0056789e, -0x00019a7e, -0x000004ca, -0x005817e6,
		 0x00584966,  0x0000364a,  0x0001cbfe, -0x0056471e,  0x00037fd2, -0x0054934a, -0x0052fd96, -0x00ab10b2,
		 0x00ad495c,  0x00553640,  0x0056cbf4, -0x00014728,  0x00587fc8,  0x00006cac,  0x00020260, -0x005610bc,
		 0x005a5090,  0x00023d74,  0x0003d328, -0x00543ff4,  0x000586fc, -0x00528c20, -0x0050f66c, -0x00a90988,
		 0x005c3d22,  0x00042a06,  0x0005bfba, -0x00525362,  0x0007738e, -0x00509f8e, -0x004f09da, -0x00a71cf6,
		 0x00094456, -0x004ecec6, -0x004d3912, -0x00a54c2e, -0x004b853e, -0x00a3985a, -0x00a202a6, -0x00fa15c2,
		 0x00af69e2,  0x005756c6,  0x0058ec7a,  0x0000d95e,  0x005aa04e,  0x00028d32,  0x000422e6, -0x0053f036,
		 0x005c7116,  0x00045dfa,  0x0005f3ae, -0x00521f6e,  0x0007a782, -0x00506b9a, -0x004ed5e6, -0x00a6e902,
		 0x005e5da8,  0x00064a8c,  0x0007e040, -0x005032dc,  0x00099414, -0x004e7f08, -0x004ce954, -0x00a4fc70,
		 0x000b64dc, -0x004cae40, -0x004b188c, -0x00a32ba8, -0x004964b8, -0x00a177d4, -0x009fe220, -0x00f7f53c,
		 0x006064d2,  0x000851b6,  0x0009e76a, -0x004e2bb2,  0x000b9b3e, -0x004c77de, -0x004ae22a, -0x00a2f546,
		 0x000d6c06, -0x004aa716, -0x00491162, -0x00a1247e, -0x00475d8e, -0x009f70aa, -0x009ddaf6, -0x00f5ee12,
		 0x000f5898, -0x0048ba84, -0x004724d0, -0x009f37ec, -0x004570fc, -0x009d8418, -0x009bee64, -0x00f40180,
		-0x0043a034, -0x009bb350, -0x009a1d9c, -0x00f230b8, -0x009869c8, -0x00f07ce4, -0x00eee730, -0x0146fa4c
	},

    ...

	{ // [31]
        ...
	}
};
#endif // PDM_FIR__H

```

# Integrer la Librairie
## Cmake
### STM32 (pour un projet Clion)
### PC

## Makefile STM32


# Structures de Données
## pdm_fit_filter_t

```c
typedef struct {
    uint16_t    buffer[PDM_FTL_TAPS];
    int         next_tap;
} pdm_fir_filter_t;
```

## pdm_fit_filter_config_t
```c
typedef struct {
    pdm_fir_filter_t*   fir_filter;
    uint16_t            decimation_factor;
    int16_t             input_offset;
    int16_t             output_offset;
    uint16_t            linear_gain;
    uint8_t             bit_scale;
} pdm_fir_filter_config_t;
```

# Fonctions

## pdm_fir_flt_init

prototype:
```c
void pdm_fir_flt_init(pdm_fit_filter_t *f);
```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f` | `pdm_fir_filter_t*` | Structure contenant les données du filtre|

Cette Fonction initialise la structure de données utilisée par le filtre PDM

## pdm_fir_flt_config_init

prototype:
```c
void pdm_fir_flt_config_init(pdm_fir_filter_config_t *f, uint16_t decimation_factor, int16_t input_offset, int16_t output_offset, uint16_t linear_gain, uint8_t bit_scale);

```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f` | `pdm_fir_filter_config_t*` | Structure contenant les données du filtre ainsi que sa configuration|
| `decimation_factor` | `uint16_t` | Facteur de decimation du filtre|*
| `input_offset` | `int16_t` | Offset à appliqué sur les échantillons PCM AVANT leur amplification |
| `output_offset` | `int16_t` | Offset à appliqué sur les échantillons PCM APRES leur amplification
| `linear_gain` | `uint16_t` | Gain linéaire à appliquer sur le signal PCM |
| `bit_scale` | `uint8_t` | Tailles des échantillons PCM en bits (Doit être inférieur au `bit_scale` définit à la génération)

Cette Fonction initialise le filtre PDM et sa configuration

## pdm_fir_flt_config_deInit

prototype:
```c
void pdm_fir_flt_config_deInit(pdm_fir_filter_config_t *f);

```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f` | `pdm_fir_filter_config_t*` | Structure contenant les données du filtre ainsi que sa configuration|

Cette Fonction désalloue les données alloué dynamiquement par la fonction [pdm_fir_flt_config_init](#pdm_fir_flt_config_init)

## pdm_fir_flt_put

prototype:
```c
void pdm_fir_flt_put(pdm_fir_filter_t *f, uint16_t bits);

```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f`       | `pdm_fir_filter_t*` | Structure contenant les données du filtre |
| `bits`    | `uint16_t` | Tailles des échantillons PCM en bits (Doit être inférieur au `bit_scale` définit à la génération) |

Cette Fonction ajoute un mot PDM de 16 bit au filtre

## pdm_fir_flt_get

prototype:
```c
void pdm_fir_flt_get(pdm_fir_filter_t *f, int out_bits);

```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f`       | `pdm_fir_filter_t*` | Structure contenant les données du filtre |
| `out_bits`    | `int` | Mot PDM (16 échantillons, MSB first) |

Cette Fonction etrait un echantillons PCM du filtre dont la valeur apartient a $`[-2^{out\_bits-1}; 2^{out\_bits -1}-1 ]`$ cependant dans certain cas il faut tronquer la valeur

## pdm_fir_flt_chunk

prototype:
```c
uint32_t pdm_fir_flt_chunk(pdm_fir_filter_config_t *f, uint16_t *pcm_output, const uint16_t *pdm_input, uint32_t pdm_size);

```


| Paramètre | Type | Commentaire |
|:---------:|:----:|:------------|
| `f`       | `pdm_fir_filter_config_t*` | Structure contenant les données du filtre ainsi que sa configuration |
| `pcm_output`| `uint16_t*` | Buffer de sortie des echantillons PCM |
| `pdm_input` | `const uint16_t*` | Buffer d'entrée des echantillons PDM |
| `pdm_size` | `uint32_t` | Nombre de mot de 16 échantillons PDM à filtrer

Retour:

|Type | Commentaire |
|:---:|:-----------|
| `uint32_t` |  Nombre d'echantillons PCM filtré |

Cette Fonction filtre le buffer PDM pour se faire la fonction applique l'agorithme suivant
```
FONCTION pdm_fir_ftl_chunk(f, pcm_output, pdm_input, pdm_size)
    decimation_word = f->decimation_factor / 16
    pcm_to_write = pdm_size/decimation_word
    POUR i DE 0 A pcm_to_write AVEC UN PAS DE 1
        POUR j DE 0 A 16 AVEC UN PAS DE 1
            pdm_fir_flt_put(f->fir_filter, pdm_input[i * decimation_word + j])
        FIN POUR
        pcm_sample = pdm_fir_flt_get(f->fir_filter, f->bit_scale)
        pcm_sample = ((pcm_sample + f->input_offset) * f->linear_gain) + f->output_offset
        SI pcm_sample SUPERIEUR STRICT A (2^f->bit_scale) - 1
            pcm_sample = (2^f->bit_scale) - 1
        FIN SI
        SI pcm_sample INFERIEUR STRICT A -((2^f->bit_scale) - 1)
            pcm_sample = -(2^f->bit_scale) - 1
        FIN SI
        pcm_buffer[i] = pcm_sample
    FIN POUR
    RETOURNER pcm_to_write
FIN FONCTION
```
